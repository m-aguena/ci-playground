name: Rerun PR CI on main changes

on:
  push:
    branches: [main]

jobs:
  rerun-pr-ci:
    runs-on: ubuntu-latest
    permissions:
      contents: write         # required
      pull-requests: write    # required
      actions: write

    steps:
      - name: List open pull requests
        id: prs
        run: |
          prs=$(gh api repos/${{ github.repository }}/pulls \
            --jq '[.[] | {number: .number}]')
          echo "prs=$(echo "$prs" | jq -c '.')" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Trigger PR CI by updating base branch
        run: |
          echo '${{ steps.prs.outputs.prs }}' | jq -c '.[]' |
          while read pr; do
            number=$(echo "$pr" | jq -r '.number')
            echo "Updating PR #$number to retrigger CI"

            gh api \
              -X POST \
              repos/${{ github.repository }}/pulls/$number/update-branch \
              || echo "PR #$number does not allow auto-update"
          done
        env:
          GH_TOKEN: ${{ github.token }}

