name: Rerun PR CI on main changes

on:
  push:
    branches: [main]

jobs:
  rerun-pr-ci:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write     # required for PATCH /pulls/{n}
      contents: read

    steps:
      - name: List open pull requests
        id: prs
        run: |
          prs=$(gh api repos/${{ github.repository }}/pulls \
            --jq '[.[] | {number: .number, title: .title}]')
          echo "prs=$(echo "$prs" | jq -c '.')" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Touch PR metadata to retrigger PR CI
        run: |
          echo '${{ steps.prs.outputs.prs }}' | jq -c '.[]' |
          while read pr; do
            number=$(echo "$pr" | jq -r '.number')
            title=$(echo "$pr" | jq -r '.title')

            echo "Touching PR #$number to retrigger CI"

            gh api \
              -X PATCH \
              repos/${{ github.repository }}/pulls/${number} \
              -F title="$title"
          done
        env:
          GH_TOKEN: ${{ github.token }}

