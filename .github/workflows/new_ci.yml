name: Unified PR CI

on:
  # Normal PR workflow
  pull_request:
    types: [opened, synchronize, reopened]

  # When another PR is merged into main
  push:
    branches:
      - main

jobs:
  get-open-prs:
    if: github.event_name == 'push'  # Only run when a PR was merged into main
    runs-on: ubuntu-latest
    outputs:
      prs: ${{ steps.collect.outputs.pr_list }}

    steps:
      - name: Fetch open PRs
        id: collect
        run: |
          prs=$(gh pr list --state open --json number -q ".[].number")
          echo "pr_list=$prs" >> $GITHUB_OUTPUT

  pr-ci:
    # Case A: normal PR run
    # Case B: triggered by "push", run for **each open PR**
    runs-on: ubuntu-latest

    needs: [get-open-prs]
    strategy:
      matrix:
        pr_number: >
          ${
            {
              github.event_name == 'pull_request'
              && fromJson(format('[{0}]', github.event.pull_request.number))
              || fromJson(needs.get-open-prs.outputs.prs)
            }
          }

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ matrix.pr_number }}/head

      - name: Run CI
        run: |
          echo "Running CI for PR #${{ matrix.pr_number }}"
          # Insert your real CI commands here:
          # npm test, cargo test, pytest, go test, etc.

