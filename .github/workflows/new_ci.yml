name: Unified PR CI

on:
  pull_request:
    types: [opened, synchronize, reopened]

  push:
    branches:
      - main

jobs:
  determine-prs:
    # This job decides which PRs to run CI for
    runs-on: ubuntu-latest
    outputs:
      pr_list: ${{ steps.set-prs.outputs.pr_list }}

    steps:
      - name: Determine PR list
        id: set-prs
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Single PR case
            echo "pr_list=[${{ github.event.pull_request.number }}]" >> $GITHUB_OUTPUT
          else
            # Merge-to-main case â†’ collect all open PRs
            prs=$(gh pr list --state open --json number -q ".[].number")
            echo "pr_list=$prs" >> $GITHUB_OUTPUT
          fi

  pr-ci:
    needs: determine-prs
    runs-on: ubuntu-latest

    strategy:
      matrix:
        pr_number: ${{ fromJson(needs.determine-prs.outputs.pr_list) }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ matrix.pr_number }}/head

      - name: Run CI
        run: |
          echo "Running CI for PR #${{ matrix.pr_number }}"
          # Add your actual build/test commands below
          # e.g., npm ci && npm test
